<?php

declare(strict_types=1);

use App\Models\User;
use FrittenKeeZ\Vouchers\Facades\Vouchers;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Notification;
use LBHurtado\Voucher\Data\VoucherInstructionsData;
use LBHurtado\Voucher\Models\Voucher;

uses(RefreshDatabase::class);

use function Pest\Laravel\{actingAs, get, post};

beforeEach(function () {
    Notification::fake();
    Http::fake();
});

/**
 * Helper function to create a test voucher
 */
function createTestVoucher(User $user, array $fields = []): Voucher
{
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $base['inputs'] = ['fields' => $fields];
    $instructions = VoucherInstructionsData::from($base);
    
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'test-secret',
    ])->withOwner($user)->create();
    
    // Verify the facade returns the correct model type
    expect($voucher)->toBeInstanceOf(Voucher::class);
    expect($voucher)->toBeInstanceOf(LBHurtado\Voucher\Models\Voucher::class);
    
    return $voucher;
}

test('complete redemption flow with all plugins', function () {
    // Given: A voucher requiring all input fields + signature
    $user = User::factory()->create();
    $voucher = createTestVoucher($user, [
        'email', 'name', 'address', 'birth_date', 'gross_monthly_income',
        'location', 'reference_code', 'otp', 'signature',
    ]);

    // Step 1: Start redemption
    get("/redeem?code={$voucher->code}")
        ->assertRedirect("/redeem/{$voucher->code}/wallet");

    // Step 2: Submit wallet info
    post("/redeem/{$voucher->code}/wallet", [
        'mobile' => '+639171234567',
        'country' => 'PH',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertRedirect("/redeem/{$voucher->code}/inputs");

    // Step 3: Submit inputs plugin
    post("/redeem/{$voucher->code}/inputs", [
        'EMAIL' => 'test@example.com',
        'NAME' => 'John Doe',
        'ADDRESS' => '123 Main St',
        'BIRTH_DATE' => '1990-01-01',
        'GMI' => '50000',
        'LOCATION' => 'Manila',
        'REF_CODE' => 'REF123',
        'OTP' => '123456',
    ])->assertRedirect("/redeem/{$voucher->code}/signature");

    // Step 4: Submit signature plugin
    post("/redeem/{$voucher->code}/signature", [
        'SIGNATURE' => 'data:image/png;base64,iVBORw0KGgoAAAANS',
    ])->assertRedirect("/redeem/{$voucher->code}/finalize");

    // Step 5: Finalize and confirm
    get("/redeem/{$voucher->code}/finalize")
        ->assertInertia(fn ($page) => $page->component('Redeem/Finalize'));

    post("/redeem/{$voucher->code}/confirm")
        ->assertRedirect("/redeem/{$voucher->code}/success");

    // Verify: Voucher is redeemed
    $voucher->refresh();
    expect($voucher->redeemed_at)->not->toBeNull();
    expect($voucher->metadata['redeemed_phone'] ?? null)->toBe('+639171234567');
    expect($voucher->metadata['redeemed_inputs'] ?? [])->toHaveKeys([
        'EMAIL',
        'NAME',
        'ADDRESS',
        'BIRTH_DATE',
        'GMI',
        'LOCATION',
        'REF_CODE',
        'OTP',
        'SIGNATURE',
    ]);
});

test('complete redemption flow with minimal fields', function () {
    // Given: A voucher requiring only wallet info (no plugins)
    $user = User::factory()->create();
    $voucher = createTestVoucher($user);

    // Step 1: Start redemption
    get("/redeem?code={$voucher->code}")
        ->assertRedirect("/redeem/{$voucher->code}/wallet");

    // Step 2: Submit wallet info
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertRedirect("/redeem/{$voucher->code}/finalize"); // Skip plugins

    // Step 3: Finalize and confirm
    post("/redeem/{$voucher->code}/confirm")
        ->assertRedirect("/redeem/{$voucher->code}/success");

    // Verify: Voucher is redeemed
    $voucher->refresh();
    expect($voucher->redeemed_at)->not->toBeNull();
});

test('redemption flow with only email field', function () {
    // Given: A voucher requiring only EMAIL
    $user = User::factory()->create();
    $voucher = createTestVoucher($user, ['email']);

    // Wallet step
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertRedirect("/redeem/{$voucher->code}/inputs");

    // Inputs plugin (only EMAIL should be validated)
    post("/redeem/{$voucher->code}/inputs", [
        'EMAIL' => 'test@example.com',
    ])->assertRedirect("/redeem/{$voucher->code}/finalize");

    // Confirm
    post("/redeem/{$voucher->code}/confirm")
        ->assertRedirect("/redeem/{$voucher->code}/success");

    $voucher->refresh();
    $redeemedInputs = $voucher->metadata['redeemed_inputs'] ?? [];
    expect($redeemedInputs)->toHaveKey('EMAIL');
    expect($redeemedInputs['EMAIL'])->toBe('test@example.com');
});

test('redemption flow validates required fields only', function () {
    // Given: Voucher requires NAME and EMAIL
    $user = User::factory()->create();
    $voucher = createTestVoucher($user, ['name', 'email']);

    // Wallet step
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertRedirect();

    // Inputs plugin with missing NAME (should fail)
    post("/redeem/{$voucher->code}/inputs", [
        'EMAIL' => 'test@example.com',
    ])->assertSessionHasErrors(['NAME']);

    // With all required fields (should pass)
    post("/redeem/{$voucher->code}/inputs", [
        'NAME' => 'John Doe',
        'EMAIL' => 'test@example.com',
        'ADDRESS' => '123 Main St', // Extra field (should be ignored gracefully)
    ])->assertRedirect("/redeem/{$voucher->code}/finalize");
});

test('redemption flow prevents double redemption', function () {
    // Given: A voucher already redeemed
    $user = User::factory()->create();
    $voucher = createTestVoucher($user);
    
    // Redeem it first
    $voucher->redeem($user);

    // Attempt to start redemption
    get("/redeem?code={$voucher->code}")
        ->assertRedirect('/redeem')
        ->assertSessionHas('error');
});

test('redemption flow validates expired vouchers', function () {
    // Given: An expired voucher
    $user = User::factory()->create();
    
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $instructions = VoucherInstructionsData::from($base);
    
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'test-secret',
    ])->withExpireTimeIn(\Carbon\CarbonInterval::seconds(1))
    ->withOwner($user)->create();
    
    expect($voucher)->toBeInstanceOf(Voucher::class);
    
    // Wait for expiration
    sleep(2);

    // Attempt wallet submission
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertSessionHasErrors(['code']);
});

test('redemption flow validates wrong secret', function () {
    // Given: A valid voucher
    $user = User::factory()->create();
    
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $instructions = VoucherInstructionsData::from($base);
    
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'correct_secret',
    ])->withOwner($user)->create();
    
    expect($voucher)->toBeInstanceOf(Voucher::class);

    // Attempt with wrong secret
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'wrong_secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertSessionHasErrors(['secret']);
});

test('redemption flow validates mobile number format', function () {
    $user = User::factory()->create();
    $voucher = createTestVoucher($user);

    // Invalid Philippine number
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '12345',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertSessionHasErrors(['mobile_number']);

    // Valid formats
    $validNumbers = ['+639171234567', '639171234567', '09171234567'];

    foreach ($validNumbers as $number) {
        post("/redeem/{$voucher->code}/wallet", [
            'mobile_number' => $number,
            'secret' => 'test-secret',
            'bank_code' => 'GCASH',
            'account_number' => '09171234567',
        ])->assertSessionDoesntHaveErrors(['mobile_number']);
    }
});

test('redemption flow session data persists across steps', function () {
    // Given: Voucher with multiple plugins
    $user = User::factory()->create();
    $voucher = createTestVoucher($user, ['email', 'signature']);

    // Step 1: Submit wallet
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '+639171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertSessionHas("redeem.{$voucher->code}.mobile", '+639171234567')
        ->assertSessionHas("redeem.{$voucher->code}.wallet", 'GCASH')
        ->assertSessionHas("redeem.{$voucher->code}.account_number", '09171234567');

    // Step 2: Submit inputs
    post("/redeem/{$voucher->code}/inputs", [
        'EMAIL' => 'test@example.com',
    ])->assertSessionHas("redeem.{$voucher->code}.inputs.EMAIL", 'test@example.com');

    // Step 3: Submit signature
    post("/redeem/{$voucher->code}/signature", [
        'SIGNATURE' => 'data:image/png;base64,test',
    ])->assertSessionHas("redeem.{$voucher->code}.signature", 'data:image/png;base64,test');

    // All session data should still be present at finalize
    get("/redeem/{$voucher->code}/finalize")
        ->assertSessionHas("redeem.{$voucher->code}.mobile")
        ->assertSessionHas("redeem.{$voucher->code}.inputs.EMAIL")
        ->assertSessionHas("redeem.{$voucher->code}.signature");
});

test('redemption flow clears session after successful completion', function () {
    // Given: Minimal voucher
    $user = User::factory()->create();
    $voucher = createTestVoucher($user);

    // Complete flow
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertSessionHas("redeem.{$voucher->code}.mobile");

    post("/redeem/{$voucher->code}/confirm");

    // Session should be marked as redeemed
    get("/redeem/{$voucher->code}/success")
        ->assertSessionHas("redeem.{$voucher->code}.redeemed", true);
});

test('cannot redeem voucher that starts in the future', function () {
    $user = User::factory()->create();
    
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $instructions = VoucherInstructionsData::from($base);
    
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'test-secret',
    ])->withOwner($user)
        ->withStartTime(now()->addDays(7))
        ->create();
    
    expect($voucher)->toBeInstanceOf(Voucher::class);
    expect($voucher->starts_at->isFuture())->toBeTrue();
    
    // Attempt to start redemption - should fail
    get("/redeem?code={$voucher->code}")
        ->assertRedirect('/redeem')
        ->assertSessionHas('error');
});

test('cannot redeem expired voucher', function () {
    $user = User::factory()->create();
    
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $instructions = VoucherInstructionsData::from($base);
    
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'test-secret',
    ])->withOwner($user)
        ->withExpireTime(now()->subDay()) // Expired yesterday
        ->create();
    
    expect($voucher)->toBeInstanceOf(Voucher::class);
    expect($voucher->expires_at->isPast())->toBeTrue();
    
    // Attempt to start redemption - should fail
    get("/redeem?code={$voucher->code}")
        ->assertRedirect('/redeem')
        ->assertSessionHas('error');
});

test('expired voucher returns error when submitting wallet info', function () {
    $user = User::factory()->create();
    
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $instructions = VoucherInstructionsData::from($base);
    
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'test-secret',
    ])->withOwner($user)
        ->withExpireTime(now()->subDay())
        ->create();
    
    // Attempt wallet submission on expired voucher
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ])->assertSessionHasErrors(['code']);
});

test('success page displays custom rider message', function () {
    $user = User::factory()->create();
    
    $customMessage = 'Thank you for your redemption! Your payment will be processed within 24 hours.';
    
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $base['rider'] = [
        'message' => $customMessage,
    ];
    $instructions = VoucherInstructionsData::from($base);
    
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'test-secret',
    ])->withOwner($user)->create();
    
    expect($voucher)->toBeInstanceOf(Voucher::class);
    
    // Complete redemption
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ]);
    
    post("/redeem/{$voucher->code}/confirm");
    
    // Check success page has custom message
    get("/redeem/{$voucher->code}/success")
        ->assertInertia(fn ($page) => $page
            ->component('Redeem/Success')
            ->has('voucher')
            ->where('voucher.instructions.rider.message', $customMessage)
        );
});

test('success page redirects to custom rider URL when configured', function () {
    $user = User::factory()->create();
    
    $customUrl = 'https://example.com/custom-thank-you';
    
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $base['rider'] = [
        'message' => 'Thank you!',
        'url' => $customUrl,
    ];
    $instructions = VoucherInstructionsData::from($base);
    
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'test-secret',
    ])->withOwner($user)->create();
    
    expect($voucher)->toBeInstanceOf(Voucher::class);
    expect($voucher->instructions->rider->redirect_url)->toBe($customUrl);
    
    // Complete redemption
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ]);
    
    post("/redeem/{$voucher->code}/confirm");
    
    // Success page should pass redirect URL to frontend
    get("/redeem/{$voucher->code}/success")
        ->assertInertia(fn ($page) => $page
            ->component('Redeem/Success')
            ->where('voucher.instructions.rider.redirect_url', $customUrl)
        );
});

test('success page uses default configuration when no rider specified', function () {
    $user = User::factory()->create();
    
    // No rider configuration
    $voucher = createTestVoucher($user);
    
    // Complete redemption
    post("/redeem/{$voucher->code}/wallet", [
        'mobile_number' => '09171234567',
        'secret' => 'test-secret',
        'bank_code' => 'GCASH',
        'account_number' => '09171234567',
    ]);
    
    post("/redeem/{$voucher->code}/confirm");
    
    // Success page should render with default config
    get("/redeem/{$voucher->code}/success")
        ->assertOk()
        ->assertInertia(fn ($page) => $page
            ->component('Redeem/Success')
            ->has('voucher')
        );
});

test('voucher with extended expiry remains valid', function () {
    $user = User::factory()->create();
    
    $base = VoucherInstructionsData::generateFromScratch()->toArray();
    $instructions = VoucherInstructionsData::from($base);
    
    // Create voucher with 90 days expiry
    $voucher = Vouchers::withMetadata([
        'instructions' => $instructions->toCleanArray(),
        'secret' => 'test-secret',
    ])->withOwner($user)
        ->withExpireTimeIn(\Carbon\CarbonInterval::days(90))
        ->create();
    
    expect($voucher)->toBeInstanceOf(Voucher::class);
    expect($voucher->expires_at)->not->toBeNull();
    expect($voucher->expires_at->isFuture())->toBeTrue();
    expect(round(abs($voucher->expires_at->diffInDays(now()))))->toBe(90.0);
    
    // Should be able to start redemption
    get("/redeem?code={$voucher->code}")
        ->assertRedirect("/redeem/{$voucher->code}/wallet");
});
