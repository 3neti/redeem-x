# Voucher Redemption Driver
# Transforms VoucherInstructionsData â†’ FormFlowInstructionsData

driver:
  name: "voucher-redemption"
  version: "1.0"
  source: "LBHurtado\\Voucher\\Data\\VoucherInstructionsData"
  target: "LBHurtado\\FormFlowManager\\Data\\FormFlowInstructionsData"

# Required mappings (even if empty, required by DriverConfigData)
mappings: {}

# Reference ID template
reference_id: "disburse-{{ code }}-{{ timestamp }}"

# Callback URLs
callbacks:
  on_complete: "{{ base_url }}/disburse/{{ code }}/complete"
  on_cancel: "{{ base_url }}/disburse"

# Step definitions
# IMPORTANT: KYC must come BEFORE BIO for auto-population to work
steps:
  # Step 0: Splash page (always shown first)
  splash:
    handler: "splash"
    step_name: "splash_page"
    config:
      content: "{{ rider.splash }}"
      timeout: "{{ rider.splash_timeout | default(0) }}"
  
  # Step 1: Wallet information (after splash if configured)
  wallet:
    handler: "form"
    step_name: "wallet_info"
    title: "Wallet Information"
    description: "Redeeming voucher {{ code }} - {{ amount | format_money }} from {{ owner_name }}"
    config:
      auto_sync:
        enabled: true
        source_field: "mobile"
        target_field: "account_number"
        condition_field: "settlement_rail"
        condition_values:
          - "INSTAPAY"
        debounce_ms: 1500
    fields:
      - name: "amount"
        type: "number"
        label: "Amount"
        default: "{{ amount }}"
        readonly: true
        required: true
      - name: "settlement_rail"
        type: "settlement_rail"
        label: "Payment Method"
        default: "INSTAPAY"
        required: true
      - name: "mobile"
        type: "text"
        label: "Mobile Number"
        placeholder: "+639171234567"
        required: true
      - name: "recipient_country"
        type: "recipient_country"
        label: "Country"
        default: "PH"
        readonly: true
        required: true
      - name: "bank_code"
        type: "bank_account"
        label: "Bank/EMI"
        default: "GXCHPHM2XXX"
        required: true
      - name: "account_number"
        type: "text"
        label: "Account Number"
        placeholder: "1234567890"
        required: true
  
  # Step 1: KYC verification (MUST be before BIO for auto-population)
  kyc:
    handler: "kyc"
    step_name: "kyc_verification"
    title: "Identity Verification"
    description: "Complete identity verification to proceed"
    condition: "{{ has_kyc }}"
  
  # Step 2: Personal Information (bio fields)
  # Auto-populates from KYC if completed using named references
  bio:
    handler: "form"
    step_name: "bio_fields"
    title: "Personal Information"
    description: "Please provide your details"
    condition: "{{ has_name or has_email or has_birth_date or has_address }}"
    config:
      # Use name-based variables for order-independent references
      # KYC handler returns: name, date_of_birth, address (see KYCHandler::flattenKYCData)
      variables:
        $kyc_name: "$kyc_verification.name"
        $kyc_email: "$kyc_verification.email"
        $kyc_birth: "$kyc_verification.date_of_birth"
        $kyc_addr: "$kyc_verification.address"
    fields:
      - name: "full_name"
        type: "text"
        label: "Full Name"
        default: "$kyc_name"
        required: true
        condition: "{{ has_name }}"
      - name: "email"
        type: "email"
        label: "Email Address"
        default: "$kyc_email"
        required: true
        condition: "{{ has_email }}"
      - name: "birth_date"
        type: "date"
        label: "Birth Date"
        default: "$kyc_birth"
        required: true
        condition: "{{ has_birth_date }}"
      - name: "address"
        type: "textarea"
        label: "Address"
        default: "$kyc_addr"
        required: false
        condition: "{{ has_address }}"
  
  # Step 3: OTP verification
  otp:
    handler: "otp"
    step_name: "otp_verification"
    title: "Verify Phone Number"
    description: "Enter the verification code sent to your phone"
    condition: "{{ has_otp }}"
    config:
      code_length: 6
      expiry_minutes: 5
  
  # Step 4: Location capture
  location:
    handler: "location"
    step_name: "location_capture"
    title: "Share Your Location"
    description: "We need your current location for verification"
    condition: "{{ has_location }}"
    config:
      require_address: true
      capture_snapshot: true
  
  # Step 4: Selfie capture
  selfie:
    handler: "selfie"
    step_name: "selfie_capture"
    title: "Take a Selfie"
    description: "Please take a clear selfie for verification"
    condition: "{{ has_selfie }}"
    config:
      width: 640
      height: 480
      quality: 0.9
  
  # Step 5: Signature capture
  signature:
    handler: "signature"
    step_name: "signature_capture"
    title: "Digital Signature"
    description: "Please provide your digital signature"
    condition: "{{ has_signature }}"
    config:
      width: 600
      height: 256
      quality: 0.85
      line_width: 2
